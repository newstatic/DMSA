# 十三、App 端交互流程

> 返回 [目录](00_README.md) | 上一节: [12_完整启动时序](12_完整启动时序.md)

---

## 13.1 App 启动流程

```mermaid
flowchart TD
    A[App 启动] --> B[创建 XPC 连接]
    B --> C{连接成功?}

    C -->|否| D[显示: 服务未运行]
    D --> E[重试连接]
    E --> B

    C -->|是| F[调用 getFullState]
    F --> G[解析 ServiceFullState]

    G --> H{检查组件错误}
    H -->|有错误| I[显示组件错误详情]
    I --> J{错误可恢复?}
    J -->|是| K[显示恢复按钮]
    J -->|否| L[显示联系支持]

    H -->|无错误| M{检查配置状态}
    M -->|配置被修补| N[显示配置修补提示]
    M -->|配置有冲突| O[显示冲突解决向导]
    M -->|配置正常| P[继续]

    N --> P
    O --> P

    P --> Q{全局状态}
    Q -->|0-4| R[显示启动进度]
    Q -->|5-6| S[显示正常状态]
    Q -->|99| T[显示错误状态]

    R --> U[订阅状态通知]
    U --> V[等待状态变更]
    V --> F

    S --> W[启用所有操作按钮]

    T --> X[显示错误详情和恢复选项]
```

## 13.2 App UI 状态映射

```mermaid
flowchart LR
    subgraph States["全局状态"]
        S0["STARTING"]
        S1["XPC_READY"]
        S2["VFS_MOUNTING"]
        S3["VFS_BLOCKED"]
        S4["INDEXING"]
        S5["READY"]
        S6["RUNNING"]
        S99["ERROR"]
    end

    subgraph Icons["菜单栏图标"]
        I1["⚪ 灰色"]
        I2["🟡 黄色"]
        I3["🟡 黄色闪烁"]
        I4["🟢 绿色"]
        I5["🔴 红色"]
    end

    subgraph StatusText["状态文字"]
        T1["服务启动中..."]
        T2["服务连接中..."]
        T3["挂载文件系统..."]
        T4["准备就绪中..."]
        T5["建立索引 N%..."]
        T6["就绪"]
        T7["运行中"]
        T8["错误: {message}"]
    end

    S0 --> I1 --> T1
    S1 --> I2 --> T2
    S2 --> I2 --> T3
    S3 --> I2 --> T4
    S4 --> I3 --> T5
    S5 --> I4 --> T6
    S6 --> I4 --> T7
    S99 --> I5 --> T8
```

## 13.3 状态与 UI 对照表

| 全局状态 | 值 | 图标 | 状态文字 | 可用操作 |
|----------|-----|------|----------|----------|
| STARTING | 0 | ⚪ 灰色 | 服务启动中... | 无 |
| XPC_READY | 1 | 🟡 黄色 | 服务连接中... | 查看状态、修改配置 |
| VFS_MOUNTING | 2 | 🟡 黄色 | 挂载文件系统... | 查看状态、修改配置 |
| VFS_BLOCKED | 3 | 🟡 黄色 | 准备就绪中... | 查看状态、修改配置 |
| INDEXING | 4 | 🟡 黄色闪烁 | 建立索引 N%... | 查看状态、修改配置 |
| READY | 5 | 🟢 绿色 | 就绪 | 全部操作 |
| RUNNING | 6 | 🟢 绿色 | 运行中 | 全部操作 |
| ERROR | 99 | 🔴 红色 | 错误: {message} | 查看错误、尝试恢复 |

---

> 下一节: [14_分布式通知](14_分布式通知.md)
