# DMSAService 流程文档

> 版本: 4.9 | 更新日期: 2026-01-27

## 核心原则

1. **XPC 第一时间启动** - App 可立即连接查询状态
2. **FUSE 预挂载** - 索引未就绪时拒绝所有文件访问
3. **状态明确可读** - 每个阶段有清晰的状态标识

---

## 文档结构

| 文件 | 内容 | 关键概念 |
|------|------|----------|
| [01_服务状态定义](01_服务状态定义.md) | 全局状态、组件状态、状态转换 | ServiceState, ComponentState |
| [02_配置管理](02_配置管理.md) | 配置加载、验证、冲突解决 | ConfigManager |
| [03_启动流程总览](03_启动流程总览.md) | 5 个启动阶段概览 | 启动时序 |
| [04_XPC通信与通知](04_XPC通信与通知.md) | 通知缓存、连接状态管理 | NotificationQueue |
| [05_状态管理器](05_状态管理器.md) | 完整状态结构、组件错误 | ServiceStateManager |
| [06_XPC优先启动](06_XPC优先启动.md) | XPC 优先启动原因和流程 | XPC Listener |
| [07_VFS预挂载机制](07_VFS预挂载机制.md) | 预挂载目的、文件操作处理 | VFSManager, FUSE |
| [08_索引构建流程](08_索引构建流程.md) | 版本管理、索引构建、进度通知 | IndexBuilder, VersionManager |
| [09_文件同步流程](09_文件同步流程.md) | 同步策略、脏文件管理 | SyncManager |
| [10_冲突处理流程](10_冲突处理流程.md) | 冲突检测、解决策略 | ConflictQueue |
| [11_热数据淘汰流程](11_热数据淘汰流程.md) | LRU 淘汰、安全检查 | EvictionManager |
| [12_完整启动时序](12_完整启动时序.md) | 完整启动时序图 | Sequence Diagram |
| [13_App端交互流程](13_App端交互流程.md) | App 状态映射、UI 交互 | DMSA.app |
| [14_分布式通知](14_分布式通知.md) | 通知事件、触发条件 | DistributedNotification |
| [15_错误处理](15_错误处理.md) | 错误分类、恢复接口 | Error Recovery |
| [16_日志规范](16_日志规范.md) | 日志格式、启动日志示例 | Logging |
| [17_检查清单](17_检查清单.md) | 启动检查清单 | Checklist |
| [20_App启动与交互流程](20_App启动与交互流程.md) | App 完整生命周期、UI 状态机、用户交互 | DMSA.app 详细设计 |

---

## 快速导航

### 按使用场景

**理解系统架构:**
- [01_服务状态定义](01_服务状态定义.md) → [03_启动流程总览](03_启动流程总览.md) → [12_完整启动时序](12_完整启动时序.md)

**开发 VFS 功能:**
- [07_VFS预挂载机制](07_VFS预挂载机制.md) (包含完整的文件操作处理流程)

**开发同步功能:**
- [09_文件同步流程](09_文件同步流程.md) → [10_冲突处理流程](10_冲突处理流程.md)

**开发 App 端:**
- [04_XPC通信与通知](04_XPC通信与通知.md) → [13_App端交互流程](13_App端交互流程.md) → [20_App启动与交互流程](20_App启动与交互流程.md) (详细设计)

**调试问题:**
- [15_错误处理](15_错误处理.md) → [16_日志规范](16_日志规范.md)

---

## 核心流程图

### 启动流程

```
launchd 启动
    ↓
[阶段 1] 环境初始化
    ↓
[阶段 2] XPC 优先启动 ⭐ → App 可连接
    ↓
[阶段 2.5] 配置加载
    ↓
[阶段 3] VFS 预挂载 → 访问返回 EBUSY
    ↓
[阶段 4] 索引构建
    ↓
[阶段 5] 完全就绪 → VFS 可正常访问
```

### 数据流

```
用户操作 ~/Downloads (TARGET_DIR)
         ↓
    VFS 层拦截
         ↓
   ┌─────┴─────┐
   ↓           ↓
读取操作    写入操作
   ↓           ↓
LOCAL 或    写入 LOCAL
EXTERNAL    标记 isDirty
   ↓           ↓
返回数据    异步同步到 EXTERNAL
```

---

## 关键术语

| 术语 | 说明 |
|------|------|
| **LOCAL_DIR** | `~/Downloads_Local`，本地热数据目录 |
| **EXTERNAL_DIR** | `/Volumes/{DiskName}/Downloads/`，外置硬盘冷数据 |
| **TARGET_DIR** | `~/Downloads`，VFS 挂载点，用户唯一访问入口 |
| **isDirty** | 脏文件标记，表示已修改但未同步 |
| **indexReady** | 索引就绪标记，控制 VFS 访问 |
| **BOTH** | 文件同时存在于 LOCAL 和 EXTERNAL |

---

*文档维护: 每次更新时同步更新此索引文件*
