# Delt MACOS Sync App (DMSA) 流程图文档

> 版本: 2.0 | 更新日期: 2026-01-20

---

## 目录

1. [系统架构图](#1-系统架构图)
2. [应用生命周期](#2-应用生命周期)
3. [硬盘事件处理](#3-硬盘事件处理)
4. [文件读取流程](#4-文件读取流程)
5. [文件写入流程](#5-文件写入流程)
6. [同步引擎流程](#6-同步引擎流程)
7. [缓存管理流程](#7-缓存管理流程)
8. [文件状态机](#8-文件状态机)
9. [错误恢复流程](#9-错误恢复流程)
10. [UI 交互流程](#10-ui-交互流程)

---

## 1. 系统架构图

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户应用层                                     │
│                    (Finder, Safari, Chrome, etc.)                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 文件操作请求
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         macOS 文件系统层                                 │
│                           (APFS / HFS+)                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Endpoint Security 事件
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    System Extension (ES Client)                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      事件分发器                                   │   │
│  │         ES_EVENT_TYPE_AUTH_* / ES_EVENT_TYPE_NOTIFY_*           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                    │                    │                    │          │
│                    ▼                    ▼                    ▼          │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   ReadRouter     │  │   WriteRouter    │  │  DeleteRouter    │      │
│  │   (读取路由)      │  │   (写入路由)      │  │  (删除路由)       │      │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘      │
└───────────┼─────────────────────┼─────────────────────┼─────────────────┘
            │                     │                     │
            └──────────────┬──────┴─────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         主应用进程                                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     VFS Core (虚拟文件系统核心)                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│          │                    │                    │                    │
│          ▼                    ▼                    ▼                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │MetadataManager│    │ CacheManager │    │ SyncScheduler│              │
│  │  (元数据管理)  │    │  (缓存管理)   │    │  (同步调度)   │              │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘              │
│         │                   │                   │                       │
│         └───────────────────┼───────────────────┘                       │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     SyncEngine (同步引擎)                         │   │
│  │                        rsync wrapper                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
            │                                           │
            ▼                                           ▼
┌─────────────────────────────┐         ┌─────────────────────────────┐
│       LOCAL 后端             │         │      EXTERNAL 后端           │
│  ~/Library/Application      │         │   /Volumes/{DiskName}/      │
│  Support/DMSA/     │         │   Downloads/                │
│  LocalCache/                │         │                             │
│                             │         │                             │
│  [热数据缓存]                │         │  [完整数据存储]              │
│  [最大空间限制]              │         │  [主存储源]                  │
│  [按修改时间淘汰]            │         │  [可能离线]                  │
└─────────────────────────────┘         └─────────────────────────────┘
            │                                           │
            └─────────────────┬─────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        ObjectBox 数据库                                  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │
│  │ FileEntry  │ │SyncHistory │ │ DiskConfig │ │ Statistics │           │
│  │ (文件索引)  │ │ (同步历史)  │ │ (硬盘配置)  │ │ (统计数据)  │           │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块依赖图

```
┌─────────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  StatusBar  │  │SettingsView │  │HistoryView  │              │
│  │  (状态栏)    │  │ (设置界面)   │  │ (历史界面)   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ AppDelegate │  │ DiskManager │  │NotificationMgr│             │
│  │  (应用代理)  │  │ (硬盘管理)   │  │ (通知管理)    │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        服务层 (Service)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │SyncScheduler│  │CacheManager │  │ConfigManager│              │
│  │ (同步调度)   │  │ (缓存管理)   │  │ (配置管理)   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│                   ┌─────────────┐                                │
│                   │ SyncEngine  │                                │
│                   │ (同步引擎)   │                                │
│                   └──────┬──────┘                                │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        核心层 (Core)                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ReadRouter  │  │ WriteRouter │  │MetadataMgr  │              │
│  │ (读取路由)   │  │ (写入路由)   │  │ (元数据管理) │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│                   ┌─────────────┐                                │
│                   │  VFSCore    │                                │
│                   │(虚拟文件系统)│                                │
│                   └──────┬──────┘                                │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        基础层 (Infrastructure)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ObjectBox   │  │RsyncWrapper │  │   Logger    │              │
│  │ (数据库)     │  │ (rsync封装) │  │ (日志系统)   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   系统扩展层 (System Extension)                   │
│                   Endpoint Security Client                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 应用生命周期

### 2.1 应用启动流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        应用启动                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 加载配置文件     │
                    │ config.json     │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 配置有效  │      │ 配置无效  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │使用默认配置│
                   │           │并提示用户 │
                   │           └────┬─────┘
                   │                │
                   └────────┬───────┘
                            ▼
                    ┌─────────────────┐
                    │ 初始化 ObjectBox │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 初始化 VFS Core  │
                    │ (虚拟文件系统)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │检查System Extension│
                    │     状态          │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 已批准    │      │ 未批准    │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │请求用户批准│
                   │           │系统扩展   │
                   │           └────┬─────┘
                   │                │
                   └────────┬───────┘
                            ▼
                    ┌─────────────────┐
                    │ 启动 ES Client   │
                    │ (订阅文件事件)    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │注册硬盘挂载通知  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查硬盘初始状态 │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │硬盘已连接 │      │硬盘未连接 │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 │
              ┌──────────┐           │
              │执行初始同步│           │
              │建立符号链接│           │
              └────┬─────┘           │
                   │                 │
                   └────────┬────────┘
                            ▼
                    ┌─────────────────┐
                    │ 设置状态栏菜单   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 启动文件监控     │
                    │ (如果配置启用)   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   应用就绪       │
                    │  进入事件循环    │
                    └─────────────────┘
```

### 2.2 应用退出流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        用户点击退出                               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查是否有       │
                    │ 未完成的同步任务  │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 有未完成  │      │ 无未完成  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 │
              ┌──────────┐           │
              │询问用户:  │           │
              │等待/强制退出│          │
              └────┬─────┘           │
                   │                 │
          ┌────────┴────────┐        │
          ▼                 ▼        │
    ┌──────────┐      ┌──────────┐   │
    │ 等待完成  │      │ 强制退出  │   │
    └────┬─────┘      └────┬─────┘   │
         │                 │         │
         ▼                 │         │
    ┌──────────┐           │         │
    │完成当前同步│           │         │
    └────┬─────┘           │         │
         │                 │         │
         └────────┬────────┴─────────┘
                  ▼
          ┌─────────────────┐
          │ 停止文件监控     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 保存脏数据状态   │
          │ 到 ObjectBox    │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 停止 ES Client  │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 关闭 ObjectBox  │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 写入最终日志     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │   应用退出       │
          └─────────────────┘
```

---

## 3. 硬盘事件处理

### 3.1 硬盘插入流程

```
┌──────────────────────────────────────────────────────────────────┐
│              NSWorkspace.didMountNotification                    │
│                     硬盘挂载通知                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取挂载路径     │
                    │ /Volumes/XXX    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查是否为       │
                    │ 配置的目标硬盘   │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 是目标硬盘│      │ 非目标硬盘│──▶ 忽略
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 延迟 2 秒        │
          │ 等待挂载稳定     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新 DiskConfig │
          │ lastConnectedAt │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查硬盘文件系统 │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │APFS/HFS+ │      │  exFAT   │
    │支持符号链接│      │不支持链接 │
    └────┬─────┘      └────┬─────┘
         │                 │
         │                 ▼
         │           ┌──────────┐
         │           │仅同步模式 │
         │           │不创建链接 │
         │           └────┬─────┘
         │                │
         └────────┬───────┘
                  ▼
          ┌─────────────────┐
          │ 检查是否有       │
          │ 待同步的脏数据   │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 有脏数据  │      │ 无脏数据  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 │
    ┌──────────┐           │
    │优先同步脏 │           │
    │数据到外置 │           │
    └────┬─────┘           │
         │                 │
         └────────┬────────┘
                  ▼
          ┌─────────────────┐
          │ 执行完整同步     │
          │ (按配置的方向)   │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 创建/更新       │
          │ 符号链接        │
          │ (如果配置启用)   │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新 ObjectBox  │
          │ 文件索引状态     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新状态栏图标   │
          │ ● 已连接        │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 发送系统通知     │
          │ "硬盘已连接"     │
          └─────────────────┘
```

### 3.2 硬盘拔出流程

```
┌──────────────────────────────────────────────────────────────────┐
│             NSWorkspace.willUnmountNotification                  │
│                     硬盘即将卸载通知                               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查是否为       │
                    │ 当前活动硬盘     │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 是活动盘 │      │ 非活动盘  │──▶ 忽略
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查是否有       │
          │ 正在进行的同步   │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 有同步中  │      │ 无同步中  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 │
    ┌──────────┐           │
    │尝试快速完成│           │
    │或安全中断 │           │
    └────┬─────┘           │
         │                 │
         └────────┬────────┘
                  ▼
          ┌─────────────────┐
          │ 标记未完成的     │
          │ 同步任务为待恢复 │
          └────────┬────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────────────┐
│             NSWorkspace.didUnmountNotification                   │
│                     硬盘已卸载通知                                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 删除符号链接     │
                    │ (如果存在)       │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 LOCAL 备份 │
                    │ 是否存在        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 备份存在  │      │ 备份不存在│
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │恢复LOCAL │      │创建空目录 │
              │为Downloads│      │Downloads│
              └────┬─────┘      └────┬─────┘
                   │                 │
                   └────────┬────────┘
                            ▼
                    ┌─────────────────┐
                    │ 更新 ObjectBox  │
                    │ 文件位置状态     │
                    │ BOTH→LOCAL_ONLY │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 更新状态栏图标   │
                    │ ○ 未连接        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 发送系统通知     │
                    │ "硬盘已断开"     │
                    └─────────────────┘
```

### 3.3 硬盘意外断开恢复流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     定时检查 (每30秒)                             │
│                     或 文件访问失败触发                            │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查符号链接     │
                    │ 目标是否可访问   │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 可访问    │      │ 不可访问  │
              │ (正常)    │      │ (悬空链接)│
              └──────────┘      └────┬─────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 检测到异常断开   │
                            │ 记录错误日志     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 立即删除悬空链接 │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 恢复 LOCAL 目录 │
                            │ 或创建空目录     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 标记所有 BOTH   │
                            │ 状态为 LOCAL_ONLY│
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 显示恢复向导     │
                            │ 引导用户检查数据 │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 发送紧急通知     │
                            │ "检测到硬盘异常" │
                            └─────────────────┘
```

---

## 4. 文件读取流程

### 4.1 读取请求处理

```
┌──────────────────────────────────────────────────────────────────┐
│                 ES_EVENT_TYPE_AUTH_OPEN                          │
│                 用户打开文件: ~/Downloads/file.pdf               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查路径是否在   │
                    │ 监控目录内       │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 在监控内  │      │ 不在监控内│──▶ ES_AUTH_RESULT_ALLOW
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 查询 ObjectBox  │
          │ 获取文件状态     │
          └────────┬────────┘
                   │
          ┌────────┴────────────────┬────────────────┐
          ▼                         ▼                ▼
    ┌───────────┐           ┌───────────┐     ┌───────────┐
    │LOCAL_ONLY │           │   BOTH    │     │EXTERNAL_  │
    │或 BOTH    │           │           │     │   ONLY    │
    └─────┬─────┘           └─────┬─────┘     └─────┬─────┘
          │                       │                 │
          ▼                       ▼                 ▼
    ┌───────────┐           ┌───────────┐     ┌───────────┐
    │文件在LOCAL│           │文件在LOCAL│     │文件仅在   │
    │直接放行   │           │直接放行   │     │EXTERNAL   │
    └─────┬─────┘           └─────┬─────┘     └─────┬─────┘
          │                       │                 │
          │                       │                 ▼
          │                       │           ┌───────────┐
          │                       │           │检查EXTERNAL│
          │                       │           │是否已连接  │
          │                       │           └─────┬─────┘
          │                       │                 │
          │                       │        ┌────────┴────────┐
          │                       │        ▼                 ▼
          │                       │  ┌──────────┐     ┌──────────┐
          │                       │  │ 已连接   │     │ 未连接   │
          │                       │  └────┬─────┘     └────┬─────┘
          │                       │       │                │
          │                       │       ▼                ▼
          │                       │  ┌──────────┐     ┌──────────┐
          │                       │  │从EXTERNAL│     │返回错误   │
          │                       │  │拉取到LOCAL│     │ENOENT    │
          │                       │  └────┬─────┘     └──────────┘
          │                       │       │
          │                       │       ▼
          │                       │  ┌──────────┐
          │                       │  │更新状态为│
          │                       │  │  BOTH   │
          │                       │  └────┬─────┘
          │                       │       │
          └───────────────────────┴───────┘
                                  │
                                  ▼
                          ┌─────────────────┐
                          │ 更新 accessedAt │
                          │ 访问时间戳       │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │ES_AUTH_RESULT_  │
                          │     ALLOW       │
                          │  (允许读取)      │
                          └─────────────────┘
```

### 4.2 从 EXTERNAL 拉取到 LOCAL

```
┌──────────────────────────────────────────────────────────────────┐
│                     需要拉取文件到 LOCAL                          │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查 LOCAL 空间 │
                    │ 是否足够        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 空间足够  │      │ 空间不足  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │执行淘汰  │
                   │           │释放空间  │
                   │           └────┬─────┘
                   │                │
                   │           ┌────┴────┐
                   │           ▼         ▼
                   │     ┌──────────┐ ┌──────────┐
                   │     │释放成功  │ │释放失败  │
                   │     └────┬─────┘ └────┬─────┘
                   │          │            │
                   │          │            ▼
                   │          │       ┌──────────┐
                   │          │       │返回错误  │
                   │          │       │ENOSPC   │
                   │          │       └──────────┘
                   │          │
                   └────┬─────┘
                        ▼
                ┌─────────────────┐
                │ 创建 LOCAL 目录 │
                │ 结构 (如需要)   │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ 复制文件        │
                │ EXTERNAL→LOCAL │
                └────────┬────────┘
                         │
                         ▼
                ┌─────────────────┐
                │ 校验文件完整性  │
                │ (checksum 对比) │
                └────────┬────────┘
                         │
                ┌────────┴────────┐
                ▼                 ▼
          ┌──────────┐      ┌──────────┐
          │ 校验通过  │      │ 校验失败  │
          └────┬─────┘      └────┬─────┘
               │                 │
               │                 ▼
               │           ┌──────────┐
               │           │删除损坏  │
               │           │重新拉取  │
               │           └──────────┘
               │
               ▼
        ┌─────────────────┐
        │ 更新 ObjectBox  │
        │ location = BOTH │
        └────────┬────────┘
                 │
                 ▼
        ┌─────────────────┐
        │ 返回 LOCAL 路径 │
        └─────────────────┘
```

---

## 5. 文件写入流程

### 5.1 写入请求处理 (Write-Back)

```
┌──────────────────────────────────────────────────────────────────┐
│                 ES_EVENT_TYPE_AUTH_CREATE                        │
│                 用户创建文件: ~/Downloads/new.zip                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查路径是否在   │
                    │ 监控目录内       │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 在监控内  │      │ 不在监控内│──▶ ES_AUTH_RESULT_ALLOW
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查 LOCAL 空间 │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 空间足够  │      │ 空间不足  │
    └────┬─────┘      └────┬─────┘
         │                 │
         │                 ▼
         │           ┌──────────┐
         │           │执行淘汰  │
         │           └────┬─────┘
         │                │
         └────────┬───────┘
                  ▼
          ┌─────────────────┐
          │ES_AUTH_RESULT_  │
          │     ALLOW       │
          │  (允许创建)      │
          └────────┬────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                 ES_EVENT_TYPE_NOTIFY_WRITE                       │
│                 文件写入完成通知                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 文件已写入 LOCAL │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 创建/更新       │
                    │ FileEntry       │
                    │ isDirty = true  │
                    │ location =      │
                    │  LOCAL_ONLY     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 加入脏数据队列   │
                    │ DirtyQueue      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 触发防抖同步     │
                    │ (5秒后执行)      │
                    └─────────────────┘
```

### 5.2 异步同步到 EXTERNAL

```
┌──────────────────────────────────────────────────────────────────┐
│                     防抖时间到达 (5秒)                            │
│                     或 硬盘刚连接                                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取脏数据队列   │
                    │ 所有待同步文件   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 EXTERNAL   │
                    │ 连接状态        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 已连接   │      │ 未连接   │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │保持队列  │
                   │           │等待重连  │
                   │           └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 批量同步脏文件   │
          │ LOCAL→EXTERNAL │
          └────────┬────────┘
                   │
                   ▼ (对每个文件)
          ┌─────────────────┐
          │ rsync 单文件    │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 同步成功  │      │ 同步失败  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │isDirty=  │      │重试计数+1│
    │  false   │      │稍后重试  │
    │location= │      └──────────┘
    │  BOTH    │
    └────┬─────┘
         │
         ▼
    ┌──────────┐
    │记录同步  │
    │历史      │
    └──────────┘
```

---

## 6. 同步引擎流程

### 6.1 完整同步流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     触发完整同步                                  │
│         (硬盘连接 / 手动触发 / 定时任务)                           │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取同步配置     │
                    │ SyncPairConfig  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 确定同步方向     │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          ▼                  ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │LOCAL →    │     │EXTERNAL → │      │双向同步   │
    │EXTERNAL   │     │LOCAL      │      │           │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          ▼                 ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │源=LOCAL   │     │源=EXTERNAL│      │双向扫描   │
    │目标=EXT   │     │目标=LOCAL │      │合并差异   │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          └────────────┬────┴──────────────────┘
                       ▼
              ┌─────────────────┐
              │ 扫描源目录      │
              │ 构建文件列表    │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 应用排除规则    │
              │ excludePatterns │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 扫描目标目录    │
              │ (或从ObjectBox) │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 计算差异        │
              │ 新增/更新/删除  │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 创建同步历史    │
              │ SyncHistory     │
              │ status=inProgress│
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 执行 rsync      │
              │ --progress      │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 更新进度回调    │
              │ (UI 显示进度)   │
              └────────┬────────┘
                       │
              ┌────────┴────────┐
              ▼                 ▼
        ┌──────────┐      ┌──────────┐
        │ 同步成功  │      │ 同步失败  │
        └────┬─────┘      └────┬─────┘
             │                 │
             ▼                 ▼
        ┌──────────┐      ┌──────────┐
        │更新History│      │记录错误  │
        │status=    │      │status=   │
        │ completed │      │ failed   │
        └────┬─────┘      └──────────┘
             │
             ▼
        ┌──────────┐
        │批量更新  │
        │FileEntry │
        │状态      │
        └────┬─────┘
             │
             ▼
        ┌──────────┐
        │更新统计  │
        │Statistics│
        └────┬─────┘
             │
             ▼
        ┌──────────┐
        │发送通知  │
        │"同步完成"│
        └──────────┘
```

### 6.2 增量同步算法

```
┌──────────────────────────────────────────────────────────────────┐
│                     增量同步差异计算                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 源文件列表 (S)   │
                    │ 目标文件列表 (D) │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 新增文件   │       │ 更新文件   │        │ 删除文件   │
  │ S有 D无   │       │ S有 D有   │        │ S无 D有   │
  │           │       │ 但不同     │        │           │
  └─────┬─────┘       └─────┬─────┘        └─────┬─────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 复制到 D  │       │比较 mtime │        │如果配置   │
  │           │       │ 或 size   │        │--delete   │
  │           │       │ 或 checksum│        │则删除    │
  └───────────┘       └─────┬─────┘        └───────────┘
                            │
                   ┌────────┴────────┐
                   ▼                 ▼
             ┌──────────┐      ┌──────────┐
             │ 有差异   │      │ 无差异   │
             └────┬─────┘      └────┬─────┘
                  │                 │
                  ▼                 ▼
             ┌──────────┐      ┌──────────┐
             │覆盖目标  │      │ 跳过     │
             └──────────┘      └──────────┘
```

---

## 7. 缓存管理流程

### 7.1 空间检查与淘汰

```
┌──────────────────────────────────────────────────────────────────┐
│                     空间检查触发                                  │
│         (写入前 / 定时检查 / 拉取前)                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 计算 LOCAL 当前 │
                    │ 占用空间        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 对比最大限制    │
                    │ maxCacheSize    │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 未超限   │      │ 已超限   │
              │ 正常运行 │      │ 需要淘汰 │
              └──────────┘      └────┬─────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 查询可淘汰文件  │
                            │ location=BOTH  │
                            │ isDirty=false  │
                            │ 按 modifiedAt  │
                            │ 升序排列       │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 计算需要释放    │
                            │ 的空间大小      │
                            │ = 当前 - 限制  │
                            │ + 预留缓冲     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 遍历淘汰列表    │
                            └────────┬────────┘
                                     │
                                     ▼ (循环)
                            ┌─────────────────┐
                            │ 删除 LOCAL 文件 │
                            │ 累加释放空间    │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 更新 FileEntry  │
                            │ location =      │
                            │ EXTERNAL_ONLY   │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 释放足够？      │
                            └────────┬────────┘
                                     │
                            ┌────────┴────────┐
                            ▼                 ▼
                      ┌──────────┐      ┌──────────┐
                      │ 是       │      │ 否       │
                      │ 完成淘汰 │      │ 继续循环 │
                      └──────────┘      └────┬─────┘
                                             │
                                             ▼
                                       ┌──────────┐
                                       │ 无更多可 │
                                       │ 淘汰文件 │
                                       │ 返回错误 │
                                       └──────────┘
```

### 7.2 淘汰优先级

```
┌──────────────────────────────────────────────────────────────────┐
│                     淘汰优先级排序                                │
└──────────────────────────────────────────────────────────────────┘

优先淘汰 (先删除)
    │
    ├─── 1. 修改时间最旧的文件
    │         modifiedAt ASC
    │
    ├─── 2. 访问时间最旧的文件 (同等修改时间)
    │         accessedAt ASC
    │
    ├─── 3. 文件大小最大的文件 (释放空间更快)
    │         size DESC
    │
    └─── 4. 非用户主动访问的文件
              (被动拉取 vs 主动打开)

不可淘汰
    │
    ├─── isDirty = true (脏数据，未同步)
    │
    ├─── location = LOCAL_ONLY (只有本地有)
    │
    └─── 用户标记为"常驻本地"的文件
```

---

## 8. 文件状态机

### 8.1 状态定义与转换

```
┌──────────────────────────────────────────────────────────────────┐
│                     FileLocation 状态机                          │
└──────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   NOT_EXISTS    │
                    │   (不存在)       │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          │ 本地创建          │ 外置创建          │ 两端都创建
          ▼                  ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │LOCAL_ONLY │     │EXTERNAL_  │      │   BOTH    │
    │           │     │   ONLY    │      │           │
    │ (仅本地)   │     │ (仅外置)   │      │ (两端都有) │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          │                 │                  │
          │    ┌────────────┼────────────┐     │
          │    │            │            │     │
          │    │ 同步到外置  │ 拉取到本地  │     │
          │    ▼            ▼            │     │
          │  ┌───────────────┐           │     │
          └─▶│    BOTH      │◀──────────┘     │
             │  (两端都有)   │                  │
             └───────┬──────┘                  │
                     │                         │
          ┌──────────┼──────────┐              │
          │          │          │              │
          │ LOCAL淘汰 │ EXTERNAL │ 双端删除     │
          ▼          │   删除   ▼              │
    ┌───────────┐    │    ┌───────────┐        │
    │EXTERNAL_  │    │    │LOCAL_ONLY │        │
    │   ONLY    │    │    │           │        │
    └───────────┘    │    └───────────┘        │
                     │                         │
                     └──────────┬──────────────┘
                                │
                                │ 完全删除
                                ▼
                    ┌─────────────────┐
                    │   NOT_EXISTS    │
                    └─────────────────┘


状态转换表:
┌─────────────┬─────────────────────┬─────────────────┐
│ 当前状态     │ 触发事件             │ 目标状态         │
├─────────────┼─────────────────────┼─────────────────┤
│ NOT_EXISTS  │ 本地创建文件         │ LOCAL_ONLY      │
│ NOT_EXISTS  │ 外置创建文件         │ EXTERNAL_ONLY   │
│ LOCAL_ONLY  │ 同步到外置完成       │ BOTH            │
│ EXTERNAL_   │ 拉取到本地完成       │ BOTH            │
│   ONLY      │                     │                 │
│ BOTH        │ 本地淘汰             │ EXTERNAL_ONLY   │
│ BOTH        │ 外置文件删除         │ LOCAL_ONLY      │
│ BOTH        │ 双端删除             │ NOT_EXISTS      │
│ LOCAL_ONLY  │ 本地删除             │ NOT_EXISTS      │
│ EXTERNAL_   │ 外置删除             │ NOT_EXISTS      │
│   ONLY      │                     │                 │
└─────────────┴─────────────────────┴─────────────────┘
```

### 8.2 脏数据状态

```
┌──────────────────────────────────────────────────────────────────┐
│                     isDirty 状态机                               │
└──────────────────────────────────────────────────────────────────┘

              ┌─────────────────┐
              │ isDirty = false │
              │   (已同步)       │
              └────────┬────────┘
                       │
                       │ 本地文件被修改
                       ▼
              ┌─────────────────┐
              │ isDirty = true  │
              │   (待同步)       │
              └────────┬────────┘
                       │
          ┌────────────┴────────────┐
          │                         │
          │ 同步到EXTERNAL成功       │ EXTERNAL离线
          ▼                         ▼
    ┌───────────┐            ┌───────────┐
    │isDirty =  │            │保持 dirty │
    │  false    │            │等待重连   │
    └───────────┘            └───────────┘
```

---

## 9. 错误恢复流程

### 9.1 同步失败恢复

```
┌──────────────────────────────────────────────────────────────────┐
│                     同步任务失败                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 记录错误信息    │
                    │ 到 SyncHistory  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 分析失败原因    │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 网络/硬盘  │       │ 权限错误   │        │ 空间不足   │
  │ 断开      │       │           │        │           │
  └─────┬─────┘       └─────┬─────┘        └─────┬─────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │加入重试队列│       │记录错误   │        │触发淘汰   │
  │等待重连   │       │通知用户   │        │重新尝试   │
  └─────┬─────┘       └───────────┘        └─────┬─────┘
        │                                        │
        │         ┌──────────────────────────────┘
        │         │
        ▼         ▼
  ┌─────────────────┐
  │ 重试策略        │
  │ 最多 3 次       │
  │ 间隔递增        │
  │ 1s → 5s → 30s  │
  └────────┬────────┘
           │
  ┌────────┴────────┐
  ▼                 ▼
┌──────────┐  ┌──────────┐
│ 重试成功  │  │ 重试失败  │
└────┬─────┘  └────┬─────┘
     │             │
     ▼             ▼
┌──────────┐  ┌──────────┐
│ 正常完成  │  │放入失败队列│
│          │  │等待手动处理│
└──────────┘  └──────────┘
```

### 9.2 数据一致性恢复

```
┌──────────────────────────────────────────────────────────────────┐
│                     数据一致性检查                                │
│                (启动时 / 硬盘重连时)                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 扫描 ObjectBox  │
                    │ 所有 FileEntry  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查实际文件    │
                    │ 是否与状态一致  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 状态正确   │       │ 文件丢失   │        │ 状态过期   │
  │           │       │ 但记录存在 │        │           │
  └───────────┘       └─────┬─────┘        └─────┬─────┘
                            │                    │
                            ▼                    ▼
                      ┌───────────┐        ┌───────────┐
                      │修正状态为 │        │更新为实际 │
                      │NOT_EXISTS │        │文件状态   │
                      └───────────┘        └───────────┘

                    ┌─────────────────┐
                    │ 检查孤立文件    │
                    │ (文件存在但无记录)│
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 创建 FileEntry  │
                    │ 补充元数据      │
                    └─────────────────┘
```

---

## 10. UI 交互流程

### 10.1 设置界面流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     用户打开设置                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 加载当前配置    │
                    │ ConfigManager   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 显示设置窗口    │
                    │ (SwiftUI)       │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 通用设置   │       │ 硬盘管理   │        │ 目录管理   │
  └───────────┘       └───────────┘        └───────────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │-开机启动  │       │-添加硬盘  │        │-添加目录对│
  │-通知设置  │       │-编辑硬盘  │        │-编辑方向  │
  │-日志级别  │       │-删除硬盘  │        │-删除目录对│
  │-缓存大小  │       │-调整优先级│        │-排除规则  │
  └───────────┘       └───────────┘        └───────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 用户修改配置    │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 保存     │      │ 取消     │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │验证配置  │      │丢弃修改  │
              └────┬─────┘      │关闭窗口  │
                   │            └──────────┘
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 验证通过  │      │ 验证失败  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │保存到JSON│      │显示错误  │
    │应用变更  │      │保持窗口  │
    │关闭窗口  │      └──────────┘
    └──────────┘
```

### 10.2 同步进度显示

```
┌──────────────────────────────────────────────────────────────────┐
│                     同步开始                                      │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 显示进度窗口    │
                    │ (如果配置启用)   │
                    └────────┬────────┘
                             │
                             ▼
              ┌───────────────────────────┐
              │     同步进度窗口          │
              ├───────────────────────────┤
              │ 正在同步: file.pdf       │
              │ ████████░░░░░░░░ 50%     │
              │                          │
              │ 已完成: 25/50 文件        │
              │ 已传输: 1.2 GB / 2.4 GB  │
              │ 速度: 45 MB/s            │
              │ 剩余: 约 30 秒            │
              │                          │
              │     [ 取消同步 ]          │
              └───────────────────────────┘
                             │
                             │ rsync 进度回调
                             ▼
                    ┌─────────────────┐
                    │ 更新进度信息    │
                    │ - 当前文件      │
                    │ - 百分比        │
                    │ - 速度          │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 同步完成  │      │ 用户取消  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │显示完成  │      │中断同步  │
              │统计信息  │      │标记待恢复│
              │关闭窗口  │      │关闭窗口  │
              └──────────┘      └──────────┘
```

---

## 附录: 流程图图例

```
┌──────────────────────────────────────────────────────────────────┐
│                        图例说明                                   │
└──────────────────────────────────────────────────────────────────┘

┌─────────────┐
│   开始/结束  │  圆角矩形 = 流程开始或结束
└─────────────┘

┌─────────────┐
│   处理步骤   │  矩形 = 处理步骤
└─────────────┘

      │
      ▼         箭头 = 流程方向
      │

┌────────┴────────┐
▼                 ▼   分支 = 条件判断
┌──────┐    ┌──────┐
│ 条件A │    │ 条件B │
└──────┘    └──────┘

──▶           单向箭头 = 数据/控制流

◀──▶          双向箭头 = 双向交互
```

---

*文档维护: 流程变更时更新此文档*
