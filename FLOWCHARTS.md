# Delt MACOS Sync App (DMSA) 流程图文档

> 版本: 3.0 | 更新日期: 2026-01-21

---

## 目录

1. [系统架构图](#1-系统架构图)
2. [应用生命周期](#2-应用生命周期)
3. [硬盘事件处理](#3-硬盘事件处理)
4. [文件读取流程](#4-文件读取流程)
5. [文件写入流程](#5-文件写入流程)
6. [同步引擎流程](#6-同步引擎流程)
7. [缓存管理流程](#7-缓存管理流程)
8. [文件状态机](#8-文件状态机)
9. [错误恢复流程](#9-错误恢复流程)
10. [UI 交互流程](#10-ui-交互流程)

---

## 1. 系统架构图

### 1.1 整体架构 (v3.0)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户应用层                                     │
│                    (Finder, Safari, Chrome, etc.)                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ 文件操作请求
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      VFS 挂载点 (TARGET_DIR)                             │
│                    ~/Downloads (FUSE-T 挂载)                            │
│                         用户唯一访问入口                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ FUSE 回调
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         DMSA VFS 核心                                    │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     VFSCore (FUSE 操作入口)                       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                    │                    │                    │          │
│                    ▼                    ▼                    ▼          │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐      │
│  │   ReadRouter     │  │   WriteRouter    │  │  MergeEngine     │      │
│  │ (读取路由-零拷贝) │  │(写入路由-Write-Back)│  │  (智能合并)      │      │
│  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘      │
└───────────┼─────────────────────┼─────────────────────┼─────────────────┘
            │                     │                     │
            └──────────────┬──────┴─────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务层                                           │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │EvictionManager│    │ SyncScheduler│    │ LockManager  │              │
│  │ (LRU淘汰管理) │    │  (同步调度)   │    │  (同步锁)     │              │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘              │
│         │                   │                   │                       │
│         └───────────────────┼───────────────────┘                       │
│                             ▼                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     SyncEngine (原生同步引擎)                      │   │
│  │                   单向同步: LOCAL → EXTERNAL                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
            │                                           │
            ▼                                           ▼
┌─────────────────────────────┐         ┌─────────────────────────────┐
│      LOCAL_DIR 后端          │         │     EXTERNAL_DIR 后端        │
│    ~/Downloads_Local        │         │   /Volumes/BACKUP/          │
│                             │         │   Downloads/                │
│                             │         │                             │
│  [热数据缓存]                │         │  [完整数据源-Source of Truth]│
│  [localQuotaGB 配额限制]     │         │  [只读备份]                  │
│  [LRU 淘汰 (按 accessedAt)]  │         │  [可能离线]                  │
│  [用户不直接访问]            │         │  [用户不直接访问]            │
└─────────────────────────────┘         └─────────────────────────────┘
            │                                           │
            └─────────────────┬─────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        ObjectBox 数据库                                  │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐           │
│  │ FileEntry  │ │SyncHistory │ │  SyncPair  │ │ Statistics │           │
│  │ (文件索引)  │ │ (同步历史)  │ │ (同步对配置) │ │ (统计数据)  │           │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘           │
└─────────────────────────────────────────────────────────────────────────┘
```

**v3.0 术语:**
| 术语 | 路径示例 | 说明 |
|------|----------|------|
| **TARGET_DIR** | `~/Downloads` | FUSE 挂载点，用户唯一访问入口 |
| **LOCAL_DIR** | `~/Downloads_Local` | 本地热数据缓存 |
| **EXTERNAL_DIR** | `/Volumes/BACKUP/Downloads` | 外部完整数据源 |

### 1.2 模块依赖图 (v3.0)

```
┌─────────────────────────────────────────────────────────────────┐
│                        表现层 (Presentation)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  StatusBar  │  │SettingsView │  │HistoryView  │              │
│  │  (状态栏)    │  │ (设置界面)   │  │ (历史界面)   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          ▼                ▼                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        应用层 (Application)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ AppDelegate │  │ DiskManager │  │NotificationMgr│             │
│  │  (应用代理)  │  │ (硬盘管理)   │  │ (通知管理)    │             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
└─────────┼────────────────┼────────────────┼─────────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        服务层 (Service)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │SyncScheduler│  │EvictionMgr  │  │ConfigManager│              │
│  │ (同步调度)   │  │(LRU淘汰管理) │  │ (配置管理)   │              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│                   ┌─────────────┐                                │
│                   │ SyncEngine  │                                │
│                   │(原生同步引擎)│                                │
│                   └──────┬──────┘                                │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        核心层 (Core)                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ReadRouter  │  │ WriteRouter │  │ MergeEngine │              │
│  │(零拷贝读取)  │  │(Write-Back) │  │(智能合并引擎)│              │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │
│         │                │                │                      │
│         └────────────────┼────────────────┘                      │
│                          ▼                                       │
│                   ┌─────────────┐                                │
│                   │  VFSCore    │                                │
│                   │(FUSE-T 入口)│                                │
│                   └──────┬──────┘                                │
└──────────────────────────┼──────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                        基础层 (Infrastructure)                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ ObjectBox   │  │ LockManager │  │   Logger    │              │
│  │ (数据库)     │  │ (同步锁)     │  │ (日志系统)   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   FUSE 层 (User Space File System)               │
│                        FUSE-T / macFUSE                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 应用生命周期

### 2.1 应用启动流程 (v3.0)

```
┌──────────────────────────────────────────────────────────────────┐
│                        应用启动                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 加载配置文件     │
                    │ config.json     │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 配置有效  │      │ 配置无效  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │使用默认配置│
                   │           │并提示用户 │
                   │           └────┬─────┘
                   │                │
                   └────────┬───────┘
                            ▼
                    ┌─────────────────┐
                    │ 初始化 ObjectBox │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 FUSE-T 安装 │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 已安装    │      │ 未安装    │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │引导用户安装│
                   │           │  FUSE-T   │
                   │           └────┬─────┘
                   │                │
                   └────────┬───────┘
                            ▼
                    ┌─────────────────┐
                    │ 对每个 SyncPair: │
                    │ 检查 TARGET_DIR │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │目录已存在 │      │目录不存在 │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 │
              ┌──────────┐           │
              │重命名为   │           │
              │LOCAL_DIR │           │
              └────┬─────┘           │
                   │                 │
                   └────────┬────────┘
                            ▼
                    ┌─────────────────┐
                    │ 创建 FUSE 挂载点 │
                    │ 挂载 VFS        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │注册硬盘挂载通知  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 EXTERNAL   │
                    │ 连接状态        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │EXTERNAL  │      │EXTERNAL  │
              │ 已连接   │      │ 未连接   │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 │
              ┌──────────┐           │
              │扫描文件树 │           │
              │构建合并视图│           │
              │同步脏数据 │           │
              └────┬─────┘           │
                   │                 │
                   └────────┬────────┘
                            ▼
                    ┌─────────────────┐
                    │ 设置状态栏菜单   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 启动 FSEvents   │
                    │ 文件监控        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │   应用就绪       │
                    │  进入事件循环    │
                    └─────────────────┘
```

### 2.2 应用退出流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        用户点击退出                               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查是否有       │
                    │ 未完成的同步任务  │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 有未完成  │      │ 无未完成  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 │
              ┌──────────┐           │
              │询问用户:  │           │
              │等待/强制退出│          │
              └────┬─────┘           │
                   │                 │
          ┌────────┴────────┐        │
          ▼                 ▼        │
    ┌──────────┐      ┌──────────┐   │
    │ 等待完成  │      │ 强制退出  │   │
    └────┬─────┘      └────┬─────┘   │
         │                 │         │
         ▼                 │         │
    ┌──────────┐           │         │
    │完成当前同步│           │         │
    └────┬─────┘           │         │
         │                 │         │
         └────────┬────────┴─────────┘
                  ▼
          ┌─────────────────┐
          │ 停止文件监控     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 保存脏数据状态   │
          │ 到 ObjectBox    │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 停止 ES Client  │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 关闭 ObjectBox  │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 写入最终日志     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │   应用退出       │
          └─────────────────┘
```

---

## 3. 硬盘事件处理

### 3.1 硬盘插入流程

```
┌──────────────────────────────────────────────────────────────────┐
│              NSWorkspace.didMountNotification                    │
│                     硬盘挂载通知                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取挂载路径     │
                    │ /Volumes/XXX    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查是否为       │
                    │ 配置的目标硬盘   │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 是目标硬盘│      │ 非目标硬盘│──▶ 忽略
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 延迟 2 秒        │
          │ 等待挂载稳定     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新 DiskConfig │
          │ lastConnectedAt │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查硬盘文件系统 │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │APFS/HFS+ │      │  exFAT   │
    │支持符号链接│      │不支持链接 │
    └────┬─────┘      └────┬─────┘
         │                 │
         │                 ▼
         │           ┌──────────┐
         │           │仅同步模式 │
         │           │不创建链接 │
         │           └────┬─────┘
         │                │
         └────────┬───────┘
                  ▼
          ┌─────────────────┐
          │ 检查是否有       │
          │ 待同步的脏数据   │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 有脏数据  │      │ 无脏数据  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 │
    ┌──────────┐           │
    │优先同步脏 │           │
    │数据到外置 │           │
    └────┬─────┘           │
         │                 │
         └────────┬────────┘
                  ▼
          ┌─────────────────┐
          │ 执行完整同步     │
          │ (按配置的方向)   │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 创建/更新       │
          │ 符号链接        │
          │ (如果配置启用)   │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新 ObjectBox  │
          │ 文件索引状态     │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 更新状态栏图标   │
          │ ● 已连接        │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 发送系统通知     │
          │ "硬盘已连接"     │
          └─────────────────┘
```

### 3.2 硬盘拔出流程

```
┌──────────────────────────────────────────────────────────────────┐
│             NSWorkspace.willUnmountNotification                  │
│                     硬盘即将卸载通知                               │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查是否为       │
                    │ 当前活动硬盘     │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 是活动盘 │      │ 非活动盘  │──▶ 忽略
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查是否有       │
          │ 正在进行的同步   │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 有同步中  │      │ 无同步中  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 │
    ┌──────────┐           │
    │尝试快速完成│           │
    │或安全中断 │           │
    └────┬─────┘           │
         │                 │
         └────────┬────────┘
                  ▼
          ┌─────────────────┐
          │ 标记未完成的     │
          │ 同步任务为待恢复 │
          └────────┬────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────────────┐
│             NSWorkspace.didUnmountNotification                   │
│                     硬盘已卸载通知                                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 删除符号链接     │
                    │ (如果存在)       │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 LOCAL 备份 │
                    │ 是否存在        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 备份存在  │      │ 备份不存在│
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │恢复LOCAL │      │创建空目录 │
              │为Downloads│      │Downloads│
              └────┬─────┘      └────┬─────┘
                   │                 │
                   └────────┬────────┘
                            ▼
                    ┌─────────────────┐
                    │ 更新 ObjectBox  │
                    │ 文件位置状态     │
                    │ BOTH→LOCAL_ONLY │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 更新状态栏图标   │
                    │ ○ 未连接        │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 发送系统通知     │
                    │ "硬盘已断开"     │
                    └─────────────────┘
```

### 3.3 硬盘意外断开恢复流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     定时检查 (每30秒)                             │
│                     或 文件访问失败触发                            │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查符号链接     │
                    │ 目标是否可访问   │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 可访问    │      │ 不可访问  │
              │ (正常)    │      │ (悬空链接)│
              └──────────┘      └────┬─────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 检测到异常断开   │
                            │ 记录错误日志     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 立即删除悬空链接 │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 恢复 LOCAL 目录 │
                            │ 或创建空目录     │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 标记所有 BOTH   │
                            │ 状态为 LOCAL_ONLY│
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 显示恢复向导     │
                            │ 引导用户检查数据 │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 发送紧急通知     │
                            │ "检测到硬盘异常" │
                            └─────────────────┘
```

---

## 4. 文件读取流程 (v3.0 零拷贝)

### 4.1 读取请求处理

```
┌──────────────────────────────────────────────────────────────────┐
│                   FUSE open() 回调                               │
│           用户打开文件: ~/Downloads/file.pdf (TARGET_DIR)        │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 解析虚拟路径     │
                    │ 提取相对路径     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 查询 ObjectBox  │
                    │ 获取文件状态     │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┬─────────────────┐
          ▼                  ▼                  ▼                 ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐     ┌───────────┐
    │LOCAL_ONLY │     │   BOTH    │      │EXTERNAL_  │     │  DELETED  │
    └─────┬─────┘     └─────┬─────┘      │   ONLY    │     └─────┬─────┘
          │                 │            └─────┬─────┘           │
          ▼                 ▼                  │                 ▼
    ┌───────────┐     ┌───────────┐            │           ┌───────────┐
    │返回LOCAL  │     │返回LOCAL  │            │           │返回错误   │
    │文件路径   │     │文件路径   │            │           │ENOENT     │
    └─────┬─────┘     └─────┬─────┘            │           └───────────┘
          │                 │                  │
          │                 │                  ▼
          │                 │           ┌───────────┐
          │                 │           │检查EXTERNAL│
          │                 │           │是否已连接  │
          │                 │           └─────┬─────┘
          │                 │                 │
          │                 │        ┌────────┴────────┐
          │                 │        ▼                 ▼
          │                 │  ┌──────────┐     ┌──────────┐
          │                 │  │ 已连接   │     │ 未连接   │
          │                 │  └────┬─────┘     └────┬─────┘
          │                 │       │                │
          │                 │       ▼                ▼
          │                 │  ┌──────────┐     ┌──────────┐
          │                 │  │v3.0 零拷贝│     │返回错误   │
          │                 │  │直接重定向 │     │ENOENT    │
          │                 │  │到EXTERNAL│     │(文件离线) │
          │                 │  │路径读取  │     └──────────┘
          │                 │  └────┬─────┘
          │                 │       │
          │                 │       │  *** 不复制到 LOCAL ***
          │                 │       │
          └─────────────────┴───────┘
                                  │
                                  ▼
                          ┌─────────────────┐
                          │ 更新 accessedAt │
                          │ 访问时间戳       │
                          │ (用于 LRU 淘汰)  │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │  返回实际路径    │
                          │ LOCAL 或 EXTERNAL│
                          └─────────────────┘
```

**v3.0 关键变更:**
- EXTERNAL_ONLY 文件**直接重定向读取**，不复制到 LOCAL
- 这是"零拷贝"读取，减少 I/O 和存储占用
- 状态保持为 EXTERNAL_ONLY，不变为 BOTH

### 4.2 v3.0 零拷贝读取说明

**v3.0 移除了"拉取到 LOCAL"流程**

在 v3.0 中，EXTERNAL_ONLY 文件直接重定向到 EXTERNAL_DIR 读取，不再复制到 LOCAL_DIR。

**原因:**
1. 减少不必要的 I/O 操作
2. 节省 LOCAL_DIR 存储空间
3. 避免重复数据
4. EXTERNAL 已连接时直接读取更高效

**例外情况:**
- 写入操作仍然写入 LOCAL_DIR (Write-Back 策略)
- 用户显式请求"下载到本地"时才复制

---

## 5. 文件写入流程

### 5.1 写入请求处理 (Write-Back)

```
┌──────────────────────────────────────────────────────────────────┐
│                 ES_EVENT_TYPE_AUTH_CREATE                        │
│                 用户创建文件: ~/Downloads/new.zip                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 检查路径是否在   │
                    │ 监控目录内       │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 在监控内  │      │ 不在监控内│──▶ ES_AUTH_RESULT_ALLOW
              └────┬─────┘      └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 检查 LOCAL 空间 │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 空间足够  │      │ 空间不足  │
    └────┬─────┘      └────┬─────┘
         │                 │
         │                 ▼
         │           ┌──────────┐
         │           │执行淘汰  │
         │           └────┬─────┘
         │                │
         └────────┬───────┘
                  ▼
          ┌─────────────────┐
          │ES_AUTH_RESULT_  │
          │     ALLOW       │
          │  (允许创建)      │
          └────────┬────────┘
                   │
                   ▼
┌──────────────────────────────────────────────────────────────────┐
│                 ES_EVENT_TYPE_NOTIFY_WRITE                       │
│                 文件写入完成通知                                   │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 文件已写入 LOCAL │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 创建/更新       │
                    │ FileEntry       │
                    │ isDirty = true  │
                    │ location =      │
                    │  LOCAL_ONLY     │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 加入脏数据队列   │
                    │ DirtyQueue      │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 触发防抖同步     │
                    │ (5秒后执行)      │
                    └─────────────────┘
```

### 5.2 异步同步到 EXTERNAL

```
┌──────────────────────────────────────────────────────────────────┐
│                     防抖时间到达 (5秒)                            │
│                     或 硬盘刚连接                                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取脏数据队列   │
                    │ 所有待同步文件   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查 EXTERNAL   │
                    │ 连接状态        │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 已连接   │      │ 未连接   │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   │                 ▼
                   │           ┌──────────┐
                   │           │保持队列  │
                   │           │等待重连  │
                   │           └──────────┘
                   │
                   ▼
          ┌─────────────────┐
          │ 批量同步脏文件   │
          │ LOCAL→EXTERNAL │
          └────────┬────────┘
                   │
                   ▼ (对每个文件)
          ┌─────────────────┐
          │ rsync 单文件    │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 同步成功  │      │ 同步失败  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │isDirty=  │      │重试计数+1│
    │  false   │      │稍后重试  │
    │location= │      └──────────┘
    │  BOTH    │
    └────┬─────┘
         │
         ▼
    ┌──────────┐
    │记录同步  │
    │历史      │
    └──────────┘
```

---

## 6. 同步引擎流程

### 6.1 完整同步流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     触发完整同步                                  │
│         (硬盘连接 / 手动触发 / 定时任务)                           │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 获取同步配置     │
                    │ SyncPairConfig  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 确定同步方向     │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          ▼                  ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │LOCAL →    │     │EXTERNAL → │      │双向同步   │
    │EXTERNAL   │     │LOCAL      │      │           │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          ▼                 ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │源=LOCAL   │     │源=EXTERNAL│      │双向扫描   │
    │目标=EXT   │     │目标=LOCAL │      │合并差异   │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          └────────────┬────┴──────────────────┘
                       ▼
              ┌─────────────────┐
              │ 扫描源目录      │
              │ 构建文件列表    │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 应用排除规则    │
              │ excludePatterns │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 扫描目标目录    │
              │ (或从ObjectBox) │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 计算差异        │
              │ 新增/更新/删除  │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 创建同步历史    │
              │ SyncHistory     │
              │ status=inProgress│
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 执行 rsync      │
              │ --progress      │
              └────────┬────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ 更新进度回调    │
              │ (UI 显示进度)   │
              └────────┬────────┘
                       │
              ┌────────┴────────┐
              ▼                 ▼
        ┌──────────┐      ┌──────────┐
        │ 同步成功  │      │ 同步失败  │
        └────┬─────┘      └────┬─────┘
             │                 │
             ▼                 ▼
        ┌──────────┐      ┌──────────┐
        │更新History│      │记录错误  │
        │status=    │      │status=   │
        │ completed │      │ failed   │
        └────┬─────┘      └──────────┘
             │
             ▼
        ┌──────────┐
        │批量更新  │
        │FileEntry │
        │状态      │
        └────┬─────┘
             │
             ▼
        ┌──────────┐
        │更新统计  │
        │Statistics│
        └────┬─────┘
             │
             ▼
        ┌──────────┐
        │发送通知  │
        │"同步完成"│
        └──────────┘
```

### 6.2 增量同步算法

```
┌──────────────────────────────────────────────────────────────────┐
│                     增量同步差异计算                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 源文件列表 (S)   │
                    │ 目标文件列表 (D) │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 新增文件   │       │ 更新文件   │        │ 删除文件   │
  │ S有 D无   │       │ S有 D有   │        │ S无 D有   │
  │           │       │ 但不同     │        │           │
  └─────┬─────┘       └─────┬─────┘        └─────┬─────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 复制到 D  │       │比较 mtime │        │如果配置   │
  │           │       │ 或 size   │        │--delete   │
  │           │       │ 或 checksum│        │则删除    │
  └───────────┘       └─────┬─────┘        └───────────┘
                            │
                   ┌────────┴────────┐
                   ▼                 ▼
             ┌──────────┐      ┌──────────┐
             │ 有差异   │      │ 无差异   │
             └────┬─────┘      └────┬─────┘
                  │                 │
                  ▼                 ▼
             ┌──────────┐      ┌──────────┐
             │覆盖目标  │      │ 跳过     │
             └──────────┘      └──────────┘
```

---

## 7. LRU 淘汰管理流程 (v3.0)

### 7.1 空间检查与 LRU 淘汰

```
┌──────────────────────────────────────────────────────────────────┐
│                     空间检查触发                                  │
│              (写入前 / 定时检查)                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 计算 LOCAL_DIR  │
                    │ 当前占用空间    │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 对比配额限制    │
                    │ localQuotaGB    │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 未超限   │      │ 已超限   │
              │ 正常运行 │      │ 需要淘汰 │
              └──────────┘      └────┬─────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 查询可淘汰文件  │
                            │ location=BOTH  │
                            │ isDirty=false  │
                            │ 按 accessedAt  │  ◀── v3.0: LRU 排序
                            │ 升序排列       │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 计算需要释放    │
                            │ 的空间大小      │
                            │ = 当前 - 限制  │
                            │ + reserveBuffer │
                            └────────┬────────┘
                                     │
                                     ▼ (循环)
                            ┌─────────────────┐
                            │ 验证 EXTERNAL   │
                            │ 文件是否存在    │
                            └────────┬────────┘
                                     │
                            ┌────────┴────────┐
                            ▼                 ▼
                      ┌──────────┐      ┌──────────┐
                      │ 存在     │      │ 不存在   │
                      └────┬─────┘      └────┬─────┘
                           │                 │
                           │                 ▼
                           │           ┌──────────┐
                           │           │先同步到  │
                           │           │EXTERNAL  │
                           │           └────┬─────┘
                           │                │
                           │       ┌────────┴────────┐
                           │       ▼                 ▼
                           │ ┌──────────┐     ┌──────────┐
                           │ │ 同步成功  │     │ 同步失败  │
                           │ └────┬─────┘     └────┬─────┘
                           │      │                │
                           └──────┤                ▼
                                  │          ┌──────────┐
                                  │          │跳过此文件│
                                  │          │(保护数据)│
                                  │          └──────────┘
                                  │
                                  ▼
                            ┌─────────────────┐
                            │ 删除 LOCAL 文件 │
                            │ 累加释放空间    │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 更新 FileEntry  │
                            │ location =      │
                            │ EXTERNAL_ONLY   │
                            └────────┬────────┘
                                     │
                                     ▼
                            ┌─────────────────┐
                            │ 释放足够？      │
                            └────────┬────────┘
                                     │
                            ┌────────┴────────┐
                            ▼                 ▼
                      ┌──────────┐      ┌──────────┐
                      │ 是       │      │ 否       │
                      │ 完成淘汰 │      │ 继续循环 │
                      └──────────┘      └──────────┘
```

### 7.2 LRU 淘汰优先级 (v3.0)

```
┌──────────────────────────────────────────────────────────────────┐
│                  v3.0 LRU 淘汰优先级排序                          │
└──────────────────────────────────────────────────────────────────┘

优先淘汰 (先删除) - 基于 accessedAt (LRU)
    │
    ├─── 1. 访问时间最旧的文件 (LRU 核心)
    │         accessedAt ASC
    │
    └─── 2. 同等访问时间时，按文件大小
              size DESC (大文件优先释放空间)

可淘汰条件 (必须同时满足)
    │
    ├─── location = BOTH (两端都有)
    │
    ├─── isDirty = false (已同步)
    │
    └─── EXTERNAL_DIR 中文件确实存在 (淘汰前验证)

不可淘汰
    │
    ├─── isDirty = true (脏数据，未同步到 EXTERNAL)
    │
    ├─── location = LOCAL_ONLY (只有本地有)
    │
    ├─── EXTERNAL_DIR 中文件不存在 (需要先同步)
    │
    └─── 正在被访问的文件 (有打开的文件句柄)
```

**v3.0 关键变更:**
- 淘汰策略从 `modifiedAt` 改为 `accessedAt` (LRU)
- 淘汰前必须验证 EXTERNAL_DIR 中文件存在
- 如果 EXTERNAL 不存在，先同步到 EXTERNAL，再淘汰
- 同步失败则跳过该文件 (保护数据完整性)

---

## 8. 文件状态机

### 8.1 状态定义与转换

```
┌──────────────────────────────────────────────────────────────────┐
│                     FileLocation 状态机                          │
└──────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   NOT_EXISTS    │
                    │   (不存在)       │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          │ 本地创建          │ 外置创建          │ 两端都创建
          ▼                  ▼                  ▼
    ┌───────────┐     ┌───────────┐      ┌───────────┐
    │LOCAL_ONLY │     │EXTERNAL_  │      │   BOTH    │
    │           │     │   ONLY    │      │           │
    │ (仅本地)   │     │ (仅外置)   │      │ (两端都有) │
    └─────┬─────┘     └─────┬─────┘      └─────┬─────┘
          │                 │                  │
          │                 │                  │
          │    ┌────────────┼────────────┐     │
          │    │            │            │     │
          │    │ 同步到外置  │ 拉取到本地  │     │
          │    ▼            ▼            │     │
          │  ┌───────────────┐           │     │
          └─▶│    BOTH      │◀──────────┘     │
             │  (两端都有)   │                  │
             └───────┬──────┘                  │
                     │                         │
          ┌──────────┼──────────┐              │
          │          │          │              │
          │ LOCAL淘汰 │ EXTERNAL │ 双端删除     │
          ▼          │   删除   ▼              │
    ┌───────────┐    │    ┌───────────┐        │
    │EXTERNAL_  │    │    │LOCAL_ONLY │        │
    │   ONLY    │    │    │           │        │
    └───────────┘    │    └───────────┘        │
                     │                         │
                     └──────────┬──────────────┘
                                │
                                │ 完全删除
                                ▼
                    ┌─────────────────┐
                    │   NOT_EXISTS    │
                    └─────────────────┘


状态转换表:
┌─────────────┬─────────────────────┬─────────────────┐
│ 当前状态     │ 触发事件             │ 目标状态         │
├─────────────┼─────────────────────┼─────────────────┤
│ NOT_EXISTS  │ 本地创建文件         │ LOCAL_ONLY      │
│ NOT_EXISTS  │ 外置创建文件         │ EXTERNAL_ONLY   │
│ LOCAL_ONLY  │ 同步到外置完成       │ BOTH            │
│ EXTERNAL_   │ 拉取到本地完成       │ BOTH            │
│   ONLY      │                     │                 │
│ BOTH        │ 本地淘汰             │ EXTERNAL_ONLY   │
│ BOTH        │ 外置文件删除         │ LOCAL_ONLY      │
│ BOTH        │ 双端删除             │ NOT_EXISTS      │
│ LOCAL_ONLY  │ 本地删除             │ NOT_EXISTS      │
│ EXTERNAL_   │ 外置删除             │ NOT_EXISTS      │
│   ONLY      │                     │                 │
└─────────────┴─────────────────────┴─────────────────┘
```

### 8.2 脏数据状态

```
┌──────────────────────────────────────────────────────────────────┐
│                     isDirty 状态机                               │
└──────────────────────────────────────────────────────────────────┘

              ┌─────────────────┐
              │ isDirty = false │
              │   (已同步)       │
              └────────┬────────┘
                       │
                       │ 本地文件被修改
                       ▼
              ┌─────────────────┐
              │ isDirty = true  │
              │   (待同步)       │
              └────────┬────────┘
                       │
          ┌────────────┴────────────┐
          │                         │
          │ 同步到EXTERNAL成功       │ EXTERNAL离线
          ▼                         ▼
    ┌───────────┐            ┌───────────┐
    │isDirty =  │            │保持 dirty │
    │  false    │            │等待重连   │
    └───────────┘            └───────────┘
```

---

## 9. 错误恢复流程

### 9.1 同步失败恢复

```
┌──────────────────────────────────────────────────────────────────┐
│                     同步任务失败                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 记录错误信息    │
                    │ 到 SyncHistory  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 分析失败原因    │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 网络/硬盘  │       │ 权限错误   │        │ 空间不足   │
  │ 断开      │       │           │        │           │
  └─────┬─────┘       └─────┬─────┘        └─────┬─────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │加入重试队列│       │记录错误   │        │触发淘汰   │
  │等待重连   │       │通知用户   │        │重新尝试   │
  └─────┬─────┘       └───────────┘        └─────┬─────┘
        │                                        │
        │         ┌──────────────────────────────┘
        │         │
        ▼         ▼
  ┌─────────────────┐
  │ 重试策略        │
  │ 最多 3 次       │
  │ 间隔递增        │
  │ 1s → 5s → 30s  │
  └────────┬────────┘
           │
  ┌────────┴────────┐
  ▼                 ▼
┌──────────┐  ┌──────────┐
│ 重试成功  │  │ 重试失败  │
└────┬─────┘  └────┬─────┘
     │             │
     ▼             ▼
┌──────────┐  ┌──────────┐
│ 正常完成  │  │放入失败队列│
│          │  │等待手动处理│
└──────────┘  └──────────┘
```

### 9.2 数据一致性恢复

```
┌──────────────────────────────────────────────────────────────────┐
│                     数据一致性检查                                │
│                (启动时 / 硬盘重连时)                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 扫描 ObjectBox  │
                    │ 所有 FileEntry  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 检查实际文件    │
                    │ 是否与状态一致  │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 状态正确   │       │ 文件丢失   │        │ 状态过期   │
  │           │       │ 但记录存在 │        │           │
  └───────────┘       └─────┬─────┘        └─────┬─────┘
                            │                    │
                            ▼                    ▼
                      ┌───────────┐        ┌───────────┐
                      │修正状态为 │        │更新为实际 │
                      │NOT_EXISTS │        │文件状态   │
                      └───────────┘        └───────────┘

                    ┌─────────────────┐
                    │ 检查孤立文件    │
                    │ (文件存在但无记录)│
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 创建 FileEntry  │
                    │ 补充元数据      │
                    └─────────────────┘
```

---

## 10. UI 交互流程

### 10.1 设置界面流程

```
┌──────────────────────────────────────────────────────────────────┐
│                     用户打开设置                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 加载当前配置    │
                    │ ConfigManager   │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 显示设置窗口    │
                    │ (SwiftUI)       │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        ▼                    ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │ 通用设置   │       │ 硬盘管理   │        │ 目录管理   │
  └───────────┘       └───────────┘        └───────────┘
        │                   │                    │
        ▼                   ▼                    ▼
  ┌───────────┐       ┌───────────┐        ┌───────────┐
  │-开机启动  │       │-添加硬盘  │        │-添加目录对│
  │-通知设置  │       │-编辑硬盘  │        │-编辑方向  │
  │-日志级别  │       │-删除硬盘  │        │-删除目录对│
  │-缓存大小  │       │-调整优先级│        │-排除规则  │
  └───────────┘       └───────────┘        └───────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 用户修改配置    │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 保存     │      │ 取消     │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │验证配置  │      │丢弃修改  │
              └────┬─────┘      │关闭窗口  │
                   │            └──────────┘
          ┌────────┴────────┐
          ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │ 验证通过  │      │ 验证失败  │
    └────┬─────┘      └────┬─────┘
         │                 │
         ▼                 ▼
    ┌──────────┐      ┌──────────┐
    │保存到JSON│      │显示错误  │
    │应用变更  │      │保持窗口  │
    │关闭窗口  │      └──────────┘
    └──────────┘
```

### 10.2 同步进度显示

```
┌──────────────────────────────────────────────────────────────────┐
│                     同步开始                                      │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ 显示进度窗口    │
                    │ (如果配置启用)   │
                    └────────┬────────┘
                             │
                             ▼
              ┌───────────────────────────┐
              │     同步进度窗口          │
              ├───────────────────────────┤
              │ 正在同步: file.pdf       │
              │ ████████░░░░░░░░ 50%     │
              │                          │
              │ 已完成: 25/50 文件        │
              │ 已传输: 1.2 GB / 2.4 GB  │
              │ 速度: 45 MB/s            │
              │ 剩余: 约 30 秒            │
              │                          │
              │     [ 取消同步 ]          │
              └───────────────────────────┘
                             │
                             │ rsync 进度回调
                             ▼
                    ┌─────────────────┐
                    │ 更新进度信息    │
                    │ - 当前文件      │
                    │ - 百分比        │
                    │ - 速度          │
                    └────────┬────────┘
                             │
                    ┌────────┴────────┐
                    ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │ 同步完成  │      │ 用户取消  │
              └────┬─────┘      └────┬─────┘
                   │                 │
                   ▼                 ▼
              ┌──────────┐      ┌──────────┐
              │显示完成  │      │中断同步  │
              │统计信息  │      │标记待恢复│
              │关闭窗口  │      │关闭窗口  │
              └──────────┘      └──────────┘
```

---

## 附录: 流程图图例

```
┌──────────────────────────────────────────────────────────────────┐
│                        图例说明                                   │
└──────────────────────────────────────────────────────────────────┘

┌─────────────┐
│   开始/结束  │  圆角矩形 = 流程开始或结束
└─────────────┘

┌─────────────┐
│   处理步骤   │  矩形 = 处理步骤
└─────────────┘

      │
      ▼         箭头 = 流程方向
      │

┌────────┴────────┐
▼                 ▼   分支 = 条件判断
┌──────┐    ┌──────┐
│ 条件A │    │ 条件B │
└──────┘    └──────┘

──▶           单向箭头 = 数据/控制流

◀──▶          双向箭头 = 双向交互
```

---

*文档维护: 流程变更时更新此文档*
